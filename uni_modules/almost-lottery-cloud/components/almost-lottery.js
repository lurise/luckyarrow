(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["uni_modules/almost-lottery-cloud/components/almost-lottery"],{"1adb":function(t,e,i){"use strict";i.r(e);var n=i("44b8"),a=i.n(n);for(var r in n)"default"!==r&&function(t){i.d(e,t,(function(){return n[t]}))}(r);e["default"]=a.a},2420:function(t,e,i){"use strict";var n=i("3d7b"),a=i.n(n);a.a},"3d7b":function(t,e,i){},"44b8":function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=r(i("a34a")),a=i("4b84");function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,i,n,a,r,o){try{var s=t[r](o),l=s.value}catch(c){return void i(c)}s.done?e(l):Promise.resolve(l).then(n,a)}function s(t){return function(){var e=this,i=arguments;return new Promise((function(n,a){var r=t.apply(e,i);function s(t){o(r,n,a,s,l,"next",t)}function l(t){o(r,n,a,s,l,"throw",t)}s(void 0)}))}}var l=t.getSystemInfoSync(),c={name:"AlmostLottery",props:{pixelRatio:{type:Number,default:2},canvasId:{type:String,default:"almostLottery"},lotterySize:{type:Number,default:600},actionSize:{type:Number,default:200},canvasMarginOutside:{type:Number,default:90},prizeList:{type:Array,required:!0,validator:function(t){return t.length>1}},prizeIndex:{type:Number,required:!0},colors:{type:Array,default:function(){return["#FFFFFF","#FFBF05"]}},lotteryBg:{type:String,default:"/uni_modules/almost-lottery/static/almost-lottery/almost-lottery__bg2x.png"},actionBg:{type:String,default:"/uni_modules/almost-lottery/static/almost-lottery/almost-lottery__action2x.png"},prizeNameDrawed:{type:Boolean,default:!0},stroked:{type:Boolean,default:!1},strokeColor:{type:String,default:"#FFBF05"},rotateType:{type:String,default:"roulette"},duration:{type:Number,default:8},ringCount:{type:Number,default:8},pointerPosition:{type:String,default:"edge",validator:function(t){return"edge"===t||"middle"===t}},strDirection:{type:String,default:"horizontal",validator:function(t){return"horizontal"===t||"vertical"===t}},strFontColors:{type:Array,default:function(){return["#FFBF05","#FFFFFF"]}},strFontSize:{type:Number,default:24},strMarginOutside:{type:Number,default:0},imgMarginStr:{type:Number,default:60},strLineHeight:{type:Number,default:1.2},strMaxLen:{type:Number,default:12},strLineLen:{type:Number,default:6},imgWidth:{type:Number,default:50},imgHeight:{type:Number,default:50},imgDrawed:{type:Boolean,default:!0},successMsg:{type:String,default:"奖品准备就绪，快来参与抽奖吧"},failMsg:{type:String,default:"奖品仍在准备中，请稍后再来..."},canvasCached:{type:Boolean,default:!1}},data:function(){return{className:"almost-lottery__canvas",lotteryPxSize:0,canvasImgPxSize:0,actionPxSize:0,strMarginPxOutside:0,imgMarginPxStr:0,imgPxWidth:0,imgPxHeight:0,lotteryImg:"",targetAngle:0,targetActionAngle:0,transitionDuration:0,isRotate:!1,stayIndex:0,targetIndex:0,isCacheImg:!1,oldLotteryImg:"",measureText:""}},computed:{higtCanvasSize:function(){return this.canvasImgPxSize*l.pixelRatio},higtFontSize:function(){return Math.round(this.strFontSize/this.pixelRatio)*l.pixelRatio},higtHeightMultiple:function(){return Math.round(this.strFontSize/this.pixelRatio)*this.strLineHeight*l.pixelRatio},canvasImgToLeftPx:function(){return(this.lotteryPxSize-this.canvasImgPxSize)/2},actionBgToLeftPx:function(){return(this.lotteryPxSize-this.actionPxSize)/2},canvasAngle:function(){var t=0,e=this.prizeList.length,i=360/e,n=90/i;return t="edge"===this.pointerPosition||"pointer"===this.rotateType?-i*n:-(i*n+i/2),t},actionAngle:function(){return 0},outsideRadius:function(){return this.higtCanvasSize/2},insideRadius:function(){return 20*l.pixelRatio},textRadius:function(){return this.strMarginPxOutside*l.pixelRatio||this.higtFontSize/2},textDistance:function(){var t=Math.round(this.outsideRadius-this.insideRadius/2);return t-this.textRadius}},watch:{prizeIndex:function(t,e){t>-1?(this.targetIndex=t,this.onRotateStart()):console.info("旋转结束，prizeIndex 已重置")}},methods:{onRotateStart:function(){var t=this;if(!this.isRotate){this.isRotate=!0;var e=this.prizeList.length,i=360/e,n=0;"pointer"===this.rotateType?(n=0===this.targetActionAngle?(this.targetIndex-this.stayIndex)*i+i/2-this.actionAngle:(this.targetIndex-this.stayIndex)*i,this.stayIndex=this.targetIndex,this.targetActionAngle+=n+360*this.ringCount,console.log("targetActionAngle",this.targetActionAngle)):(n=0===this.targetAngle?270-(this.targetIndex-this.stayIndex)*i-i/2-this.canvasAngle:-(this.targetIndex-this.stayIndex)*i,this.stayIndex=this.targetIndex,this.targetAngle+=n+360*this.ringCount);var a=1e3*this.transitionDuration+100,r=setTimeout((function(){clearTimeout(r),r=null,t.isRotate=!1,t.$emit("draw-end")}),a),o=setTimeout((function(){clearTimeout(o),o=null,t.$emit("reset-index")}),a+50)}},handleActionStart:function(){this.lotteryImg&&(this.isRotate||this.$emit("draw-start"))},onCreateCanvas:function(){var e=this;return s(n.default.mark((function i(){var r,o,s,c,u,d,h,g,f,m,x,p,y,v,I,b,S,z,P,F,k,T,w,L,C,M,R,A,N,_,D,H,B,W,$,O,J,j,q,Q,E,G;return n.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:r=e.canvasId,o=t.createCanvasContext(r,e),s=e.higtCanvasSize,c=e.higtCanvasSize,u=e.prizeList.length,d=2*Math.PI/u,o.setFontSize(e.higtFontSize),h=0;case 8:if(!(h<u)){i.next=114;break}if(g=e.prizeList[h],f=h*d,o.save(),o.beginPath(),o.arc(.5*s,.5*c,e.outsideRadius,f,f+d,!1),o.arc(.5*s,.5*c,e.insideRadius,f+d,f,!0),2===e.colors.length?o.setFillStyle(e.colors[h%2]):o.setFillStyle(e.colors[h]),o.fill(),1===e.strFontColors.length?o.setFillStyle(e.strFontColors[0]):2===e.strFontColors.length?o.setFillStyle(e.strFontColors[h%2]):o.setFillStyle(e.strFontColors[h]),e.stroked&&(o.setStrokeStyle("".concat(e.strokeColor)),o.stroke()),m=.5*s+Math.cos(f+d/2)*e.textDistance,x=.5*c+Math.sin(f+d/2)*e.textDistance,o.translate(m,x),p=e.strLimit(g.prizeName),o.rotate(f+d/2+Math.PI/2),"horizontal"!==e.strDirection){i.next=72;break}if(!p||!e.prizeNameDrawed){i.next=70;break}if(y=(0,a.clacTextLen)(p).realLen,v=y>e.strLineLen,!v){i.next=56;break}for(I="",b="",S=0,z=0;z<p.length;z++)S+=(0,a.clacTextLen)(p[z]).byteLen,S<=2*e.strLineLen?I+=p[z]:b+=p[z];p=I+","+b,P=p.split(","),F=0;case 36:if(!(F<P.length)){i.next=54;break}if(!(o.measureText&&o.measureText(P[F]).width>0)){i.next=43;break}k=o.measureText(P[F]),T=-(k.width/2).toFixed(2),o.fillText(P[F],T,F*e.higtHeightMultiple),i.next=51;break;case 43:return e.measureText=P[F],i.next=46,e.$nextTick();case 46:return i.next=48,e.getTextWidth();case 48:w=i.sent,L=-(w/2).toFixed(2),o.fillText(P[F],L,F*e.higtHeightMultiple);case 51:F++,i.next=36;break;case 54:i.next=70;break;case 56:if(!(o.measureText&&o.measureText(p).width>0)){i.next=62;break}C=o.measureText(p),M=-(C.width/2).toFixed(2),o.fillText(p,M,0),i.next=70;break;case 62:return e.measureText=p,i.next=65,e.$nextTick();case 65:return i.next=67,e.getTextWidth();case 67:R=i.sent,A=-(R/2).toFixed(2),o.fillText(p,A,0);case 70:i.next=92;break;case 72:N=p.split(""),_=0;case 74:if(!(_<N.length)){i.next=92;break}if(!(o.measureText&&o.measureText(N[_]).width>0)){i.next=81;break}D=o.measureText(N[_]),H=-(D.width/2).toFixed(2),o.fillText(N[_],H,_*e.higtHeightMultiple),i.next=89;break;case 81:return e.measureText=N[_],i.next=84,e.$nextTick();case 84:return i.next=86,e.getTextWidth();case 86:B=i.sent,W=-(B/2).toFixed(2),o.fillText(N[_],W,_*e.higtHeightMultiple);case 89:_++,i.next=74;break;case 92:if(!e.imgDrawed||!g.prizeImage||"vertical"===e.strDirection){i.next=110;break}if($=/^(https|http)/g,!$.test(g.prizeImage)){i.next=105;break}return O="",O="需要处理好下载域名的白名单问题，",console.warn("###当前数据列表中的奖品图片为网络图片，".concat(O,"开始尝试下载图片...###")),i.next=100,(0,a.downloadFile)(g.prizeImage);case 100:J=i.sent,console.log("处理远程图片",J),J.ok?(j=J.tempFilePath,g.prizeImage=j):e.handlePrizeImgSuc({ok:!1,data:J.data,msg:J.msg}),i.next=105;break;case 105:q=-e.imgPxWidth*l.pixelRatio/2,Q=e.imgMarginPxStr*l.pixelRatio,E=e.imgPxWidth*l.pixelRatio,G=e.imgPxHeight*l.pixelRatio,o.drawImage(g.prizeImage,q,Q,E,G);case 110:o.restore();case 111:h++,i.next=8;break;case 114:o.draw(!0,(function(){var i=setTimeout((function(){clearTimeout(i),i=null,t.canvasToTempFilePath({canvasId:e.canvasId,success:function(t){e.handlePrizeImg({ok:!0,data:t.tempFilePath,msg:"画布导出生成图片成功"})},fail:function(t){e.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}},e)}),500)}));case 115:case"end":return i.stop()}}),i)})))()},handlePrizeImg:function(e){var i=this;if(e.ok){var n=e.data;if(!this.canvasCached)return this.lotteryImg=n,void this.handlePrizeImgSuc(e);this.isCacheImg?t.getSavedFileList({success:function(t){var a=t.fileList,r=!1;if(a.length)for(var o=0;o<a.length;o++){var s=a[o];if(s.filePath===n){r=!0,i.lotteryImg=n,console.info("经查，本地缓存中存在的转盘图可用，本次将不再绘制转盘"),i.handlePrizeImgSuc(e);break}}r||(console.info("经查，本地缓存中存在的转盘图不可用，需要重新初始化转盘绘制"),i.initCanvasDraw())},fail:function(t){i.initCanvasDraw()}}):t.saveFile({tempFilePath:n,success:function(t){var e=t.savedFilePath;(0,a.setStore)("".concat(i.canvasId,"LotteryImg"),e),i.lotteryImg=e,i.handlePrizeImgSuc({ok:!0,data:e,msg:"画布导出生成图片成功"})},fail:function(t){i.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}})}else console.error("处理导出的图片失败",e),t.showToast({title:e.msg,mask:!0,icon:"none"}),console.error("###当前为小程序端，下载网络图片需要配置域名白名单###")},handlePrizeImgSuc:function(t){this.$emit("finish",{ok:t.ok,data:t.data,msg:t.ok?this.successMsg:this.failMsg})},getTextWidth:function(){console.warn("正在采用兼容方式获取文本的 size 信息，虽然没有任何问题，如果可以，请将此 systemInfo 及 hbx 版本号 反馈给作者",l);var e=t.createSelectorQuery().in(this),i=e.select(".almost-lottery__measureText");return new Promise((function(t,e){i.fields({size:!0},(function(e){t(e.width)})).exec()}))},strLimit:function(t){var e=this.strMaxLen;return t&&e&&(0,a.clacTextLen)(t).realLen>e?t.slice(0,e-1)+"..":t},checkCacheImg:function(){console.log("检查本地缓存中是否存在转盘图"),this.oldLotteryImg=(0,a.getStore)("".concat(this.canvasId,"LotteryImg"));var t=(0,a.getStore)("".concat(this.canvasId,"PrizeList")),e=JSON.stringify(this.prizeList);if(this.oldLotteryImg&&t===e)return console.log("经查，本地缓存中存在转盘图 => ".concat(this.oldLotteryImg)),this.isCacheImg=!0,console.log("需要继续判断这张缓存图是否可用"),void this.handlePrizeImg({ok:!0,data:this.oldLotteryImg,msg:"画布导出生成图片成功"});console.log("经查，本地缓存中不存在转盘图"),this.initCanvasDraw()},initCanvasDraw:function(){console.log("开始初始化转盘绘制"),this.isCacheImg=!1,this.lotteryImg="",(0,a.clearStore)("".concat(this.canvasId,"LotteryImg")),(0,a.setStore)("".concat(this.canvasId,"PrizeList"),this.prizeList),this.onCreateCanvas()},beforeInit:function(){var e=this;return s(n.default.mark((function i(){var a,r,o,s,l,c,u;return n.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:return a=t.createSelectorQuery().in(e),i.next=3,new Promise((function(t){a.select(".almost-lottery__wrap").boundingClientRect((function(e){t(e)})).exec()}));case 3:return r=i.sent,i.next=6,new Promise((function(t){a.select(".lottery-action").boundingClientRect((function(e){t(e)})).exec()}));case 6:return o=i.sent,i.next=9,new Promise((function(t){a.select(".str-margin-outside").boundingClientRect((function(e){t(e)})).exec()}));case 9:return s=i.sent,i.next=12,new Promise((function(t){a.select(".img-margin-str").boundingClientRect((function(e){t(e)})).exec()}));case 12:return l=i.sent,i.next=15,new Promise((function(t){a.select(".img-size").boundingClientRect((function(e){t(e)})).exec()}));case 15:c=i.sent,e.lotteryPxSize=Math.floor(r.width),e.canvasImgPxSize=e.lotteryPxSize-Math.floor(o.left)+Math.floor(r.left),e.actionPxSize=Math.floor(o.width),e.strMarginPxOutside=Math.floor(s.left)-Math.floor(r.left),e.imgMarginPxStr=Math.floor(l.left)-Math.floor(r.left),e.imgPxWidth=Math.floor(c.width),e.imgPxHeight=Math.floor(c.height),u=setTimeout((function(){clearTimeout(u),u=null,e.canvasCached?e.checkCacheImg():e.initCanvasDraw(),e.transitionDuration=e.duration}),50);case 24:case"end":return i.stop()}}),i)})))()}},mounted:function(){var t=this;this.$nextTick((function(){var e=50;e=300;var i=setTimeout((function(){clearTimeout(i),i=null,t.beforeInit()}),e)}))}};e.default=c}).call(this,i("a821")["default"])},"459b":function(t,e,i){"use strict";i.r(e);var n=i("a84b"),a=i("1adb");for(var r in a)"default"!==r&&function(t){i.d(e,t,(function(){return a[t]}))}(r);i("2420");var o,s=i("f0c5"),l=Object(s["a"])(a["default"],n["b"],n["c"],!1,null,"3a3cd00c",null,!1,n["a"],o);e["default"]=l.exports},a84b:function(t,e,i){"use strict";var n;i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return r})),i.d(e,"a",(function(){return n}));var a=function(){var t=this,e=t.$createElement;t._self._c},r=[]}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'uni_modules/almost-lottery-cloud/components/almost-lottery-create-component',
    {
        'uni_modules/almost-lottery-cloud/components/almost-lottery-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('a821')['createComponent'](__webpack_require__("459b"))
        })
    },
    [['uni_modules/almost-lottery-cloud/components/almost-lottery-create-component']]
]);
